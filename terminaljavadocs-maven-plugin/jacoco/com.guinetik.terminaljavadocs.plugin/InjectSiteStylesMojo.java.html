<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InjectSiteStylesMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
<!-- <!-- terminal-javadocs-injected [coverage] -->
<link rel="stylesheet" href="../../../terminal-styles/terminaljavadocs-coverage.min.css">
<script src="../../../terminal-styles/terminaljavadocs.min.js" defer></script>
</head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Terminal Javadocs Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">com.guinetik.terminaljavadocs.plugin</a> &gt; <span class="el_source">InjectSiteStylesMojo.java</span></div><h1>InjectSiteStylesMojo.java</h1><pre class="source lang-java linenums">package com.guinetik.terminaljavadocs.plugin;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.StandardCopyOption;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.project.MavenProject;

/**
 * Injects Terminal Javadocs styling (CSS + JS) into all HTML files
 * generated by the Maven site.
 *
 * &lt;p&gt;
 * This Mojo runs after site generation and:
 * &lt;ul&gt;
 * &lt;li&gt;Copies page-type-specific CSS files to the site directory&lt;/li&gt;
 * &lt;li&gt;Recursively scans all HTML files in the site directory&lt;/li&gt;
 * &lt;li&gt;Detects page type (coverage, jxr, javadoc, site)&lt;/li&gt;
 * &lt;li&gt;Injects the appropriate CSS and JS for each page type&lt;/li&gt;
 * &lt;li&gt;Supports nested sites (mono-repo style)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;
 * The CSS/JS files are built from the css-zen-garden design system
 * using npm and output to this plugin's resources.
 */
@Mojo(name = &quot;inject-styles&quot;, defaultPhase = org.apache.maven.plugins.annotations.LifecyclePhase.POST_SITE)
<span class="fc" id="L42">public class InjectSiteStylesMojo extends AbstractMojo {</span>

    /**
     * Page types with their corresponding CSS files.
     *
     * &lt;p&gt;
     * Each page type maps to a specific minified CSS file that provides
     * Terminal Javadocs styling for that category of generated documentation.
     */
<span class="fc" id="L51">    public enum PageType {</span>
        /** Landing pages (coverage.html, source-xref.html). */
<span class="fc" id="L53">        LANDING(&quot;landing&quot;, &quot;terminaljavadocs-landing.min.css&quot;),</span>
        /** JaCoCo coverage report pages. */
<span class="fc" id="L55">        COVERAGE(&quot;coverage&quot;, &quot;terminaljavadocs-coverage.min.css&quot;),</span>
        /** JXR source cross-reference pages. */
<span class="fc" id="L57">        JXR(&quot;jxr&quot;, &quot;terminaljavadocs-jxr.min.css&quot;),</span>
        /** Javadoc API documentation pages. */
<span class="fc" id="L59">        JAVADOC(&quot;javadoc&quot;, &quot;terminaljavadocs-javadoc.min.css&quot;),</span>
        /** General Maven site pages. */
<span class="fc" id="L61">        SITE(&quot;site&quot;, &quot;terminaljavadocs-site.min.css&quot;);</span>

        /** The short name used in injection markers. */
        private final String name;

        /** The minified CSS filename for this page type. */
        private final String cssFile;

        /**
         * Creates a page type with its associated CSS file.
         *
         * @param name    the short name for logging and markers
         * @param cssFile the minified CSS filename
         */
<span class="fc" id="L75">        PageType(String name, String cssFile) {</span>
<span class="fc" id="L76">            this.name = name;</span>
<span class="fc" id="L77">            this.cssFile = cssFile;</span>
<span class="fc" id="L78">        }</span>

        /**
         * Returns the short name of this page type.
         *
         * @return the name used in injection markers (e.g., &quot;javadoc&quot;)
         */
        public String getName() {
<span class="fc" id="L86">            return name;</span>
        }

        /**
         * Returns the CSS filename for this page type.
         *
         * @return the minified CSS filename (e.g., &quot;terminaljavadocs-javadoc.min.css&quot;)
         */
        public String getCssFile() {
<span class="fc" id="L95">            return cssFile;</span>
        }
    }

    /** Resource path prefix for styles within the plugin JAR. */
    private static final String STYLES_RESOURCE_PATH = &quot;styles/&quot;;

    /** Filename of the bundled JavaScript file. */
    private static final String JS_FILE = &quot;terminaljavadocs.min.js&quot;;

    /** Resource path prefix for themed JaCoCo images within the plugin JAR. */
    private static final String JACOCO_RESOURCES_PATH = &quot;jacoco-resources/&quot;;

    /**
     * JaCoCo resource files to copy (themed coverage bar images).
     * These replace JaCoCo's default images with Terminal Javadocs styled versions.
     */
<span class="fc" id="L112">    private static final String[] JACOCO_RESOURCE_FILES = {</span>
        &quot;branchfc.gif&quot;, &quot;branchnc.gif&quot;, &quot;branchpc.gif&quot;,
        &quot;greenbar.gif&quot;, &quot;redbar.gif&quot;,
        &quot;down.gif&quot;, &quot;up.gif&quot;, &quot;sort.gif&quot;
    };

    /**
     * HTML comment marker to detect already-injected pages.
     * Prevents duplicate style injection on re-runs.
     */
    private static final String INJECTION_MARKER = &quot;&lt;!-- terminal-javadocs-injected&quot;;

    /**
     * The current Maven session, providing access to reactor projects.
     */
    @Parameter(defaultValue = &quot;${session}&quot;, readonly = true, required = true)
    private MavenSession session;

    /**
     * The current Maven project being built.
     */
    @Parameter(defaultValue = &quot;${project}&quot;, readonly = true, required = true)
    private MavenProject project;

    /**
     * Skip style injection when set to {@code true}.
     * Can be set via {@code -Dterminaljavadocs.skip=true}.
     */
    @Parameter(property = &quot;terminaljavadocs.skip&quot;, defaultValue = &quot;false&quot;)
    private boolean skip;

    /**
     * The project's build output directory (typically {@code target/}).
     */
    @Parameter(defaultValue = &quot;${project.build.directory}&quot;, readonly = true)
    private File buildDirectory;

    /**
     * Directory name where styles will be copied within the site.
     */
    @Parameter(property = &quot;terminaljavadocs.stylesDir&quot;, defaultValue = &quot;terminal-styles&quot;)
    private String stylesDir;

    /**
     * Whether to process nested module sites.
     */
    @Parameter(property = &quot;terminaljavadocs.processNestedSites&quot;, defaultValue = &quot;true&quot;)
    private boolean processNestedSites;

    /**
     * Project name for branding in the navigation header.
     * Replaces the %%PROJECT_NAME%% token in JavaScript.
     */
    @Parameter(property = &quot;terminaljavadocs.project.name&quot;, defaultValue = &quot;${project.name}&quot;)
    private String projectName;

    /**
     * Project logo URL for branding in the navigation header.
     * Replaces the %%PROJECT_LOGO%% token in JavaScript.
     * Can be an absolute URL or a path relative to the site root.
     */
    @Parameter(property = &quot;terminaljavadocs.project.logo&quot;, defaultValue = &quot;&quot;)
    private String projectLogo;

    /** Counter for total HTML files processed. */
<span class="fc" id="L177">    private int processedFiles = 0;</span>

    /** Counter for landing pages processed. */
<span class="fc" id="L180">    private int landingFiles = 0;</span>

    /** Counter for coverage report pages processed. */
<span class="fc" id="L183">    private int coverageFiles = 0;</span>

    /** Counter for JXR source pages processed. */
<span class="fc" id="L186">    private int jxrFiles = 0;</span>

    /** Counter for Javadoc pages processed. */
<span class="fc" id="L189">    private int javadocFiles = 0;</span>

    /** Counter for general site pages processed. */
<span class="fc" id="L192">    private int siteFiles = 0;</span>

    /**
     * Executes the style injection goal.
     *
     * &lt;p&gt;
     * This method:
     * &lt;ol&gt;
     * &lt;li&gt;Locates the site output directory (staging or site)&lt;/li&gt;
     * &lt;li&gt;Copies CSS and JS resources to the styles directory&lt;/li&gt;
     * &lt;li&gt;Replaces JaCoCo's default images with themed versions&lt;/li&gt;
     * &lt;li&gt;Recursively processes all HTML files, injecting appropriate styles&lt;/li&gt;
     * &lt;li&gt;Processes nested module sites if enabled&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @throws MojoExecutionException if file operations fail
     */
    @Override
    public void execute() throws MojoExecutionException {
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if (skip) {</span>
<span class="fc" id="L212">            getLog().info(&quot;Skipping style injection&quot;);</span>
<span class="fc" id="L213">            return;</span>
        }

        try {
            // Determine the site directory - prefer staging if it exists
<span class="fc" id="L218">            File siteDir = new File(buildDirectory, &quot;staging&quot;);</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">            if (!siteDir.exists()) {</span>
<span class="fc" id="L220">                siteDir = new File(buildDirectory, &quot;site&quot;);</span>
            }

<span class="fc bfc" id="L223" title="All 2 branches covered.">            if (!siteDir.exists()) {</span>
<span class="fc" id="L224">                getLog().info(&quot;No site directory found, skipping style injection&quot;);</span>
<span class="fc" id="L225">                return;</span>
            }

<span class="fc" id="L228">            getLog().info(&quot;Injecting Terminal Javadocs styles into site: &quot; + siteDir.getAbsolutePath());</span>

            // Copy style resources to the site directory
<span class="fc" id="L231">            File stylesTargetDir = new File(siteDir, stylesDir);</span>
<span class="fc" id="L232">            copyStyleResources(stylesTargetDir);</span>

            // Replace JaCoCo's default resources with themed versions
<span class="fc" id="L235">            themeJacocoResources(siteDir);</span>

            // Process the main site
<span class="fc" id="L238">            processHtmlFiles(siteDir, siteDir);</span>

            // Process nested module sites if enabled
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">            if (processNestedSites) {</span>
<span class="fc" id="L242">                List&lt;MavenProject&gt; projects = session.getProjects();</span>

                // First, process staged module subdirectories (for site:stage)
                // When using site:stage, modules are aggregated as subdirectories within
                // target/staging
<span class="fc bfc" id="L247" title="All 2 branches covered.">                if (siteDir.getName().equals(&quot;staging&quot;)) {</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">                    for (MavenProject reactorProject : projects) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                        if (reactorProject.equals(project)) {</span>
<span class="nc" id="L250">                            continue; // Skip parent</span>
                        }

<span class="nc" id="L253">                        String artifactId = reactorProject.getArtifactId();</span>
<span class="nc" id="L254">                        File moduleStagedDir = new File(siteDir, artifactId);</span>

<span class="nc bnc" id="L256" title="All 4 branches missed.">                        if (moduleStagedDir.exists() &amp;&amp; moduleStagedDir.isDirectory()) {</span>
                            // Copy styles to staged module subdirectory
<span class="nc" id="L258">                            File moduleStylesDir = new File(moduleStagedDir, stylesDir);</span>
<span class="nc" id="L259">                            copyStyleResources(moduleStylesDir);</span>

                            // Replace JaCoCo resources in this module
<span class="nc" id="L262">                            themeJacocoResources(moduleStagedDir);</span>

<span class="nc" id="L264">                            getLog().info(&quot;Processing staged module site: &quot; + artifactId);</span>
<span class="nc" id="L265">                            processHtmlFiles(moduleStagedDir, moduleStagedDir);</span>
                        }
<span class="nc" id="L267">                    }</span>
                }

                // Fallback: process individual module site directories (for mvn site without
                // staging)
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">                for (MavenProject reactorProject : projects) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    if (reactorProject.equals(project)) {</span>
<span class="nc" id="L274">                        continue; // Skip parent, already processed</span>
                    }

<span class="nc" id="L277">                    String buildDir = reactorProject.getBuild().getDirectory();</span>

                    // Check staging first, then site
<span class="nc" id="L280">                    File moduleSiteDir = new File(buildDir, &quot;staging&quot;);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                    if (!moduleSiteDir.exists()) {</span>
<span class="nc" id="L282">                        moduleSiteDir = new File(buildDir, &quot;site&quot;);</span>
                    }

<span class="nc bnc" id="L285" title="All 2 branches missed.">                    if (moduleSiteDir.exists()) {</span>
<span class="nc" id="L286">                        String artifactId = reactorProject.getArtifactId();</span>

                        // Copy styles to module site
<span class="nc" id="L289">                        File moduleStylesDir = new File(moduleSiteDir, stylesDir);</span>
<span class="nc" id="L290">                        copyStyleResources(moduleStylesDir);</span>

                        // Replace JaCoCo resources in this module
<span class="nc" id="L293">                        themeJacocoResources(moduleSiteDir);</span>

<span class="nc" id="L295">                        getLog().info(&quot;Processing individual module site: &quot; + artifactId);</span>
<span class="nc" id="L296">                        processHtmlFiles(moduleSiteDir, moduleSiteDir);</span>
                    }
<span class="nc" id="L298">                }</span>
            }

            // Log statistics
<span class="fc" id="L302">            getLog().info(&quot;Style injection complete:&quot;);</span>
<span class="fc" id="L303">            getLog().info(&quot;  Total HTML files processed: &quot; + processedFiles);</span>
<span class="fc" id="L304">            getLog().info(&quot;  Landing pages: &quot; + landingFiles);</span>
<span class="fc" id="L305">            getLog().info(&quot;  Coverage pages: &quot; + coverageFiles);</span>
<span class="fc" id="L306">            getLog().info(&quot;  JXR pages: &quot; + jxrFiles);</span>
<span class="fc" id="L307">            getLog().info(&quot;  Javadoc pages: &quot; + javadocFiles);</span>
<span class="fc" id="L308">            getLog().info(&quot;  Site pages: &quot; + siteFiles);</span>

<span class="nc" id="L310">        } catch (IOException e) {</span>
<span class="nc" id="L311">            throw new MojoExecutionException(&quot;Failed to inject styles&quot;, e);</span>
<span class="fc" id="L312">        }</span>
<span class="fc" id="L313">    }</span>

    /**
     * Copies all style resources (CSS and JS) from the plugin JAR to the target directory.
     * JavaScript files are processed for token replacement.
     *
     * @param targetDir the directory to copy resources to (will be created if needed)
     * @throws IOException if file copying fails
     */
    private void copyStyleResources(File targetDir) throws IOException {
<span class="fc" id="L323">        targetDir.mkdirs();</span>

        // Copy CSS for each page type
<span class="fc bfc" id="L326" title="All 2 branches covered.">        for (PageType pageType : PageType.values()) {</span>
<span class="fc" id="L327">            copyResource(</span>
<span class="fc" id="L328">                    STYLES_RESOURCE_PATH + pageType.getCssFile(),</span>
<span class="fc" id="L329">                    new File(targetDir, pageType.getCssFile()));</span>
        }

        // Copy JS with token replacement
<span class="fc" id="L333">        copyJsWithTokenReplacement(STYLES_RESOURCE_PATH + JS_FILE, new File(targetDir, JS_FILE));</span>
<span class="fc" id="L334">    }</span>

    /**
     * Copies a JavaScript file with token replacement for project branding.
     *
     * &lt;p&gt;
     * Replaces the following tokens:
     * &lt;ul&gt;
     * &lt;li&gt;{@code %%PROJECT_NAME%%} - replaced with {@link #projectName}&lt;/li&gt;
     * &lt;li&gt;{@code %%PROJECT_LOGO%%} - replaced with {@link #projectLogo}&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param resourcePath the classpath resource path to copy from
     * @param targetFile   the target file to copy to
     * @throws IOException if file reading or writing fails
     */
    private void copyJsWithTokenReplacement(String resourcePath, File targetFile) throws IOException {
<span class="fc" id="L351">        try (InputStream is = getResourceStream(resourcePath)) {</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (is != null) {</span>
                // Java 8 compatible way to read all bytes from InputStream
<span class="fc" id="L354">                java.io.ByteArrayOutputStream buffer = new java.io.ByteArrayOutputStream();</span>
<span class="fc" id="L355">                byte[] data = new byte[4096];</span>
                int bytesRead;
<span class="fc bfc" id="L357" title="All 2 branches covered.">                while ((bytesRead = is.read(data, 0, data.length)) != -1) {</span>
<span class="fc" id="L358">                    buffer.write(data, 0, bytesRead);</span>
                }
<span class="fc" id="L360">                String content = new String(buffer.toByteArray(), StandardCharsets.UTF_8);</span>

                // Replace tokens
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">                content = content.replace(&quot;%%PROJECT_NAME%%&quot;, projectName != null ? projectName : &quot;&quot;);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">                content = content.replace(&quot;%%PROJECT_LOGO%%&quot;, projectLogo != null ? projectLogo : &quot;&quot;);</span>

<span class="fc" id="L366">                Files.write(targetFile.toPath(), content.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L367">                getLog().debug(&quot;Copied JS with token replacement: &quot; + resourcePath + &quot; -&gt; &quot; + targetFile);</span>
<span class="fc" id="L368">                getLog().debug(&quot;  PROJECT_NAME: &quot; + projectName);</span>
<span class="fc" id="L369">                getLog().debug(&quot;  PROJECT_LOGO: &quot; + projectLogo);</span>
<span class="fc" id="L370">            } else {</span>
<span class="nc" id="L371">                getLog().warn(&quot;Resource not found: &quot; + resourcePath +</span>
                        &quot;. Run 'npm run build' in css-zen-garden to generate it.&quot;);
            }
        }
<span class="fc" id="L375">    }</span>

    /**
     * Copies a single resource file from the plugin JAR to the filesystem.
     *
     * @param resourcePath the classpath resource path to copy from
     * @param targetFile   the target file to copy to
     * @throws IOException if file copying fails
     */
    private void copyResource(String resourcePath, File targetFile) throws IOException {
<span class="fc" id="L385">        try (InputStream is = getResourceStream(resourcePath)) {</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">            if (is != null) {</span>
<span class="fc" id="L387">                Files.copy(is, targetFile.toPath(), StandardCopyOption.REPLACE_EXISTING);</span>
<span class="fc" id="L388">                getLog().debug(&quot;Copied resource: &quot; + resourcePath + &quot; -&gt; &quot; + targetFile);</span>
            } else {
<span class="nc" id="L390">                getLog().warn(&quot;Resource not found: &quot; + resourcePath +</span>
                        &quot;. Run 'npm run build' in css-zen-garden to generate it.&quot;);
            }
        }
<span class="fc" id="L394">    }</span>

    /**
     * Copies themed JaCoCo resources (coverage bar images) to a jacoco-resources directory.
     *
     * @param jacocoResourcesDir the JaCoCo resources directory to update
     * @throws IOException if file copying fails
     */
    private void copyJacocoResources(File jacocoResourcesDir) throws IOException {
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (!jacocoResourcesDir.exists()) {</span>
<span class="nc" id="L404">            return;</span>
        }

<span class="nc bnc" id="L407" title="All 2 branches missed.">        for (String fileName : JACOCO_RESOURCE_FILES) {</span>
<span class="nc" id="L408">            copyResource(JACOCO_RESOURCES_PATH + fileName, new File(jacocoResourcesDir, fileName));</span>
        }
<span class="nc" id="L410">        getLog().debug(&quot;Copied themed JaCoCo resources to: &quot; + jacocoResourcesDir);</span>
<span class="nc" id="L411">    }</span>

    /**
     * Finds and themes all JaCoCo resource directories in the given site directory.
     * Recursively walks the directory tree looking for {@code jacoco-resources} folders.
     *
     * @param siteDir the site directory to search
     * @throws IOException if directory traversal or file copying fails
     */
    private void themeJacocoResources(File siteDir) throws IOException {
<span class="fc" id="L421">        Files.walkFileTree(siteDir.toPath(), new SimpleFileVisitor&lt;Path&gt;() {</span>
            @Override
            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
<span class="pc bpc" id="L424" title="2 of 4 branches missed.">                if (dir.getFileName() != null &amp;&amp; dir.getFileName().toString().equals(&quot;jacoco-resources&quot;)) {</span>
<span class="nc" id="L425">                    copyJacocoResources(dir.toFile());</span>
                }
<span class="fc" id="L427">                return FileVisitResult.CONTINUE;</span>
            }
        });
<span class="fc" id="L430">    }</span>

    /**
     * Gets an input stream for a classpath resource, trying multiple classloaders.
     *
     * &lt;p&gt;
     * Attempts loading in this order:
     * &lt;ol&gt;
     * &lt;li&gt;Thread context classloader&lt;/li&gt;
     * &lt;li&gt;Class classloader&lt;/li&gt;
     * &lt;li&gt;Direct resource stream with leading slash&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @param resourcePath the resource path to load
     * @return the input stream, or {@code null} if not found
     */
    private InputStream getResourceStream(String resourcePath) {
<span class="fc" id="L447">        InputStream is = Thread.currentThread()</span>
<span class="fc" id="L448">                .getContextClassLoader()</span>
<span class="fc" id="L449">                .getResourceAsStream(resourcePath);</span>

<span class="pc bpc" id="L451" title="1 of 2 branches missed.">        if (is == null) {</span>
<span class="nc" id="L452">            is = InjectSiteStylesMojo.class.getClassLoader().getResourceAsStream(resourcePath);</span>
        }

<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (is == null) {</span>
<span class="nc" id="L456">            is = InjectSiteStylesMojo.class.getResourceAsStream(&quot;/&quot; + resourcePath);</span>
        }

<span class="fc" id="L459">        return is;</span>
    }

    /**
     * Processes all HTML files in the given directory recursively.
     *
     * @param directory the directory to scan for HTML files
     * @param siteRoot  the root of the site (for relative path calculations)
     * @throws IOException if file traversal or processing fails
     */
    private void processHtmlFiles(File directory, File siteRoot) throws IOException {
<span class="fc" id="L470">        Files.walkFileTree(directory.toPath(), new SimpleFileVisitor&lt;Path&gt;() {</span>
            @Override
            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
<span class="fc bfc" id="L473" title="All 2 branches covered.">                if (file.toString().endsWith(&quot;.html&quot;)) {</span>
<span class="fc" id="L474">                    processHtmlFile(file.toFile(), siteRoot);</span>
                }
<span class="fc" id="L476">                return FileVisitResult.CONTINUE;</span>
            }

            @Override
            public FileVisitResult visitFileFailed(Path file, IOException exc) throws IOException {
<span class="nc" id="L481">                getLog().warn(&quot;Failed to visit file: &quot; + file + &quot; - &quot; + exc.getMessage());</span>
<span class="nc" id="L482">                return FileVisitResult.CONTINUE;</span>
            }
        });
<span class="fc" id="L485">    }</span>

    /**
     * Processes a single HTML file by detecting its type and injecting appropriate styles.
     *
     * @param htmlFile the HTML file to process
     * @param siteRoot the root of the site (for relative path calculations)
     * @throws IOException if file reading or writing fails
     */
    private void processHtmlFile(File htmlFile, File siteRoot) throws IOException {
<span class="fc" id="L495">        String content = new String(Files.readAllBytes(htmlFile.toPath()), StandardCharsets.UTF_8);</span>

        // Check if styles are already injected (avoid duplicate injection)
<span class="fc bfc" id="L498" title="All 2 branches covered.">        if (content.contains(INJECTION_MARKER)) {</span>
<span class="fc" id="L499">            getLog().debug(&quot;Skipping already injected file: &quot; + htmlFile);</span>
<span class="fc" id="L500">            return;</span>
        }

        // Detect page type
<span class="fc" id="L504">        PageType pageType = detectPageType(htmlFile, content);</span>

        // Calculate relative path to styles directory
<span class="fc" id="L507">        String relativePath = calculateRelativePath(htmlFile, siteRoot);</span>

        // Generate the style injection snippet
<span class="fc" id="L510">        String styleSnippet = generateStyleSnippet(pageType, relativePath);</span>

        // Inject styles before &lt;/head&gt;
<span class="fc" id="L513">        String modifiedContent = injectStyles(content, styleSnippet);</span>

<span class="pc bpc" id="L515" title="1 of 2 branches missed.">        if (modifiedContent != null) {</span>
<span class="fc" id="L516">            Files.write(htmlFile.toPath(), modifiedContent.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L517">            processedFiles++;</span>

            // Update statistics
<span class="pc bpc" id="L520" title="1 of 6 branches missed.">            switch (pageType) {</span>
                case LANDING:
<span class="fc" id="L522">                    landingFiles++;</span>
<span class="fc" id="L523">                    break;</span>
                case COVERAGE:
<span class="fc" id="L525">                    coverageFiles++;</span>
<span class="fc" id="L526">                    break;</span>
                case JXR:
<span class="fc" id="L528">                    jxrFiles++;</span>
<span class="fc" id="L529">                    break;</span>
                case JAVADOC:
<span class="fc" id="L531">                    javadocFiles++;</span>
<span class="fc" id="L532">                    break;</span>
                case SITE:
<span class="fc" id="L534">                    siteFiles++;</span>
                    break;
            }

<span class="fc" id="L538">            getLog().debug(&quot;Injected &quot; + pageType.getName() + &quot; styles into: &quot; + htmlFile);</span>
        }
<span class="fc" id="L540">    }</span>

    /**
     * Detects the page type based on file path and content.
     *
     * &lt;p&gt;
     * Detection priority:
     * &lt;ol&gt;
     * &lt;li&gt;Filename match (coverage.html, source-xref.html)&lt;/li&gt;
     * &lt;li&gt;Path-based detection (/jacoco/, /xref/, /apidocs/)&lt;/li&gt;
     * &lt;li&gt;Content-based detection (HTML markers)&lt;/li&gt;
     * &lt;li&gt;Default to SITE type&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @param htmlFile the HTML file being processed
     * @param content  the file's content
     * @return the detected page type
     */
    private PageType detectPageType(File htmlFile, String content) {
<span class="fc" id="L559">        String path = htmlFile.getAbsolutePath().replace('\\', '/').toLowerCase();</span>
<span class="fc" id="L560">        String fileName = htmlFile.getName().toLowerCase();</span>

        // Landing pages (generated by generate-landing-pages goal)
<span class="fc bfc" id="L563" title="All 4 branches covered.">        if (fileName.equals(&quot;coverage.html&quot;) || fileName.equals(&quot;source-xref.html&quot;)) {</span>
<span class="fc" id="L564">            return PageType.LANDING;</span>
        }

        // Path-based detection (most reliable)
<span class="pc bpc" id="L568" title="1 of 4 branches missed.">        if (path.contains(&quot;/jacoco/&quot;) || path.contains(&quot;/coverage/&quot;)) {</span>
<span class="fc" id="L569">            return PageType.COVERAGE;</span>
        }
<span class="pc bpc" id="L571" title="1 of 4 branches missed.">        if (path.contains(&quot;/xref/&quot;) || path.contains(&quot;/xref-test/&quot;)) {</span>
<span class="fc" id="L572">            return PageType.JXR;</span>
        }
<span class="pc bpc" id="L574" title="2 of 6 branches missed.">        if (path.contains(&quot;/apidocs/&quot;) || path.contains(&quot;/testapidocs/&quot;) || path.contains(&quot;/javadoc/&quot;)) {</span>
<span class="fc" id="L575">            return PageType.JAVADOC;</span>
        }

        // Content-based detection (fallback)
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">        if (isLandingContent(content)) {</span>
<span class="nc" id="L580">            return PageType.LANDING;</span>
        }
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">        if (isJacocoContent(content)) {</span>
<span class="nc" id="L583">            return PageType.COVERAGE;</span>
        }
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">        if (isJxrContent(content)) {</span>
<span class="nc" id="L586">            return PageType.JXR;</span>
        }
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">        if (isJavadocContent(content)) {</span>
<span class="nc" id="L589">            return PageType.JAVADOC;</span>
        }

        // Default to site
<span class="fc" id="L593">        return PageType.SITE;</span>
    }

    /**
     * Checks if content is from a landing page (coverage.html or source-xref.html).
     *
     * @param content the HTML content to check
     * @return {@code true} if landing page markers are found
     */
    private boolean isLandingContent(String content) {
<span class="pc bpc" id="L603" title="1 of 2 branches missed.">        return content.contains(&quot;class=\&quot;terminal-header\&quot;&quot;) ||</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;terminal-brand\&quot;&quot;) ||</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;module-list\&quot;&quot;);</span>
    }

    /**
     * Checks if content is from a JaCoCo coverage report.
     *
     * @param content the HTML content to check
     * @return {@code true} if JaCoCo markers are found
     */
    private boolean isJacocoContent(String content) {
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">        return content.contains(&quot;jacoco&quot;) ||</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">                content.contains(&quot;Coverage Report&quot;) ||</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;el_package\&quot;&quot;) ||</span>
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;el_class\&quot;&quot;) ||</span>
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;ctr2\&quot;&quot;);</span>
    }

    /**
     * Checks if content is from a JXR source cross-reference page.
     *
     * @param content the HTML content to check
     * @return {@code true} if JXR markers are found
     */
    private boolean isJxrContent(String content) {
<span class="pc bpc" id="L629" title="1 of 2 branches missed.">        return content.contains(&quot;jxr&quot;) ||</span>
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">                content.contains(&quot;Cross-Reference&quot;) ||</span>
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;jxr_&quot;) ||</span>
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">                content.contains(&quot;id=\&quot;jxr_&quot;);</span>
    }

    /**
     * Checks if content is from Javadoc API documentation.
     *
     * @param content the HTML content to check
     * @return {@code true} if Javadoc markers are found
     */
    private boolean isJavadocContent(String content) {
<span class="pc bpc" id="L642" title="1 of 2 branches missed.">        return content.contains(&quot;Generated by javadoc&quot;) ||</span>
<span class="pc bpc" id="L643" title="1 of 2 branches missed.">                content.contains(&quot;&lt;!-- Generated by javadoc&quot;) ||</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;summary-table\&quot;&quot;) ||</span>
<span class="pc bpc" id="L645" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;member-signature\&quot;&quot;) ||</span>
<span class="pc bpc" id="L646" title="1 of 2 branches missed.">                content.contains(&quot;class=\&quot;description\&quot;&quot;);</span>
    }

    /**
     * Calculates the relative path from an HTML file's directory to the site root.
     *
     * @param htmlFile the HTML file being processed
     * @param siteRoot the root directory of the site
     * @return the relative path with trailing slash (e.g., &quot;../../../&quot;)
     */
    private String calculateRelativePath(File htmlFile, File siteRoot) {
<span class="fc" id="L657">        Path htmlPath = htmlFile.toPath().getParent();</span>
<span class="fc" id="L658">        Path rootPath = siteRoot.toPath();</span>

        try {
<span class="fc" id="L661">            Path relativePath = htmlPath.relativize(rootPath);</span>
<span class="fc" id="L662">            String result = relativePath.toString().replace('\\', '/');</span>
<span class="fc bfc" id="L663" title="All 2 branches covered.">            if (result.isEmpty()) {</span>
<span class="fc" id="L664">                return &quot;./&quot;;</span>
            }
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">            if (!result.endsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L667">                result += &quot;/&quot;;</span>
            }
<span class="fc" id="L669">            return result;</span>
<span class="nc" id="L670">        } catch (IllegalArgumentException e) {</span>
            // Paths are on different roots, use absolute
<span class="nc" id="L672">            return &quot;./&quot;;</span>
        }
    }

    /**
     * Generates the HTML snippet to inject for a given page type.
     *
     * &lt;p&gt;
     * The snippet includes:
     * &lt;ul&gt;
     * &lt;li&gt;An HTML comment marker for detection&lt;/li&gt;
     * &lt;li&gt;A CSS link tag for the page-specific stylesheet&lt;/li&gt;
     * &lt;li&gt;A deferred script tag for the JavaScript bundle&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param pageType     the type of page being processed
     * @param relativePath the relative path to the site root
     * @return the HTML snippet to inject
     */
    private String generateStyleSnippet(PageType pageType, String relativePath) {
<span class="fc" id="L692">        String stylesPath = relativePath + stylesDir + &quot;/&quot;;</span>

<span class="fc" id="L694">        return &quot;\n&lt;!-- &quot; + INJECTION_MARKER + &quot; [&quot; + pageType.getName() + &quot;] --&gt;\n&quot; +</span>
<span class="fc" id="L695">                &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;&quot; + stylesPath + pageType.getCssFile() + &quot;\&quot;&gt;\n&quot; +</span>
                &quot;&lt;script src=\&quot;&quot; + stylesPath + JS_FILE + &quot;\&quot; defer&gt;&lt;/script&gt;\n&quot;;
    }

    /**
     * Injects the style snippet into HTML content before the closing head tag.
     *
     * &lt;p&gt;
     * Injection strategy:
     * &lt;ol&gt;
     * &lt;li&gt;Try to inject before {@code &lt;/head&gt;} (preferred)&lt;/li&gt;
     * &lt;li&gt;Fall back to after {@code &lt;head&gt;} if no closing tag&lt;/li&gt;
     * &lt;li&gt;Return {@code null} if no head section found&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @param content      the HTML content to modify
     * @param styleSnippet the style snippet to inject
     * @return the modified content, or {@code null} if injection failed
     */
    private String injectStyles(String content, String styleSnippet) {
        // Try to inject before &lt;/head&gt;
<span class="fc" id="L716">        Pattern headPattern = Pattern.compile(&quot;(&lt;/head&gt;)&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="fc" id="L717">        Matcher matcher = headPattern.matcher(content);</span>

<span class="pc bpc" id="L719" title="1 of 2 branches missed.">        if (matcher.find()) {</span>
<span class="fc" id="L720">            return content.substring(0, matcher.start()) +</span>
                    styleSnippet +
<span class="fc" id="L722">                    content.substring(matcher.start());</span>
        }

        // If no &lt;/head&gt;, try after &lt;head&gt;
<span class="nc" id="L726">        Pattern headOpenPattern = Pattern.compile(&quot;(&lt;head[^&gt;]*&gt;)&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L727">        Matcher openMatcher = headOpenPattern.matcher(content);</span>

<span class="nc bnc" id="L729" title="All 2 branches missed.">        if (openMatcher.find()) {</span>
<span class="nc" id="L730">            return content.substring(0, openMatcher.end()) +</span>
                    styleSnippet +
<span class="nc" id="L732">                    content.substring(openMatcher.end());</span>
        }

        // No head section found
<span class="nc" id="L736">        getLog().warn(&quot;No &lt;head&gt; section found in HTML, cannot inject styles&quot;);</span>
<span class="nc" id="L737">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>